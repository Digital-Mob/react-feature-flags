"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var React=_interopDefault(require("react"));const FEATURE_FLAGS_STORAGE_KEY="feature:flags",FEATURE_FLAGS_REFRESH_INTERVAL=3e5,FeatureFlagsContext=React.createContext(new Map);function loadFeatureFlags(){const e=window.localStorage.getItem(FEATURE_FLAGS_STORAGE_KEY);if(e)try{const t=JSON.parse(e);if((t.createdAt||0)+FEATURE_FLAGS_REFRESH_INTERVAL>=Date.now())return new Map(t.flags)}catch(e){}}function storeFeatureFlags(e){if(e&&e.size>0){const t=JSON.stringify({flags:Array.from(e.entries()),createdAt:Date.now()});window.localStorage.setItem(FEATURE_FLAGS_STORAGE_KEY,t)}else window.localStorage.removeItem(FEATURE_FLAGS_STORAGE_KEY)}function fetchFeaturesFlags(e){return window.fetch(e).then(e=>e.json()).then(e=>{return(e&&e.featureFlags||[]).reduce((e,t)=>(t.enabled&&e.set(t.name,t),e),new Map)})}class FeatureFlagsProvider extends React.PureComponent{constructor(){super(...arguments),this.state={featureFlags:new Map},this.intervalID=null}componentDidMount(){const{refreshInterval:e=FEATURE_FLAGS_REFRESH_INTERVAL}=this.props,t=loadFeatureFlags();t?this.setState(e=>({...e,featureFlags:t})):this.getFeaturesFlags(),this.intervalID=setInterval(()=>{this.getFeaturesFlags()},e)}componentWillUnmount(){this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null)}render(){const{children:e}=this.props,{featureFlags:t}=this.state;return React.createElement(FeatureFlagsContext.Provider,{value:t},e)}getFeaturesFlags(){const{url:e}=this.props;fetchFeaturesFlags(e).then(e=>{this.setState(t=>({...t,featureFlags:e})),storeFeatureFlags(e)})}}const FeatureFlagsWidget=e=>{const{children:t,flags:a,exact:r=!0,fallback:s}=e,n=[].concat(a||[]);return React.createElement(FeatureFlagsContext.Consumer,null,e=>{return(r?n.every(t=>e.has(t)):n.some(t=>e.has(t)))?t:s&&s()||null})};exports.FeatureFlagsProvider=FeatureFlagsProvider,exports.FeatureFlagsWidget=FeatureFlagsWidget;
